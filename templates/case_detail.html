{% extends "base.html" %}

{% block title %}Case Details - CourtLens{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('search_history') }}">History</a></li>
                <li class="breadcrumb-item active">Case Details</li>
            </ol>
        </nav>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>
                    Case Details: {{ case.case_type|title }} {{ case.case_number }}/{{ case.case_year }}
                </h4>
            </div>
            
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <!-- Basic Information -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-info-circle me-2"></i>Basic Information
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-6 mb-3">
                                        <strong>Case Type:</strong><br>
                                        <span class="text-primary">{{ case.case_type|title }}</span>
                                    </div>
                                    <div class="col-sm-6 mb-3">
                                        <strong>Case Number:</strong><br>
                                        <span class="text-primary">{{ case.case_number }}</span>
                                    </div>
                                    <div class="col-sm-6 mb-3">
                                        <strong>Case Year:</strong><br>
                                        <span class="text-primary">{{ case.case_year }}</span>
                                    </div>
                                    {% if case.diary_number %}
                                    <div class="col-sm-6 mb-3">
                                        <strong>Diary Number:</strong><br>
                                        <span class="text-primary">{{ case.diary_number }}</span>
                                    </div>
                                    {% endif %}
                                    {% if case.court_number %}
                                    <div class="col-sm-6 mb-3">
                                        <strong>Court Number:</strong><br>
                                        <span class="text-primary">{{ case.court_number }}</span>
                                    </div>
                                    {% endif %}
                                    {% if case.status %}
                                    <div class="col-sm-6 mb-3">
                                        <strong>Status:</strong><br>
                                        <span class="badge bg-warning text-dark">{{ case.status }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Parties Information -->
                        {% if case.parties %}
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-users me-2"></i>Parties
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-0">{{ case.parties }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Important Dates -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-calendar me-2"></i>Important Dates
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% if case.filing_date %}
                                    <div class="col-sm-6 mb-3">
                                        <strong>Filing Date:</strong><br>
                                        <i class="fas fa-calendar-plus text-primary me-2"></i>
                                        {{ case.filing_date }}
                                    </div>
                                    {% endif %}
                                    
                                    {% if case.next_hearing_date %}
                                    <div class="col-sm-6 mb-3">
                                        <strong>Next Hearing Date:</strong><br>
                                        <i class="fas fa-calendar-day text-warning me-2"></i>
                                        {{ case.next_hearing_date }}
                                    </div>
                                    {% endif %}
                                    
                                    {% if case.listing_date %}
                                    <div class="col-sm-6 mb-3">
                                        <strong>Listing Date:</strong><br>
                                        <i class="fas fa-calendar text-info me-2"></i>
                                        {{ case.listing_date }}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="col-sm-6 mb-3">
                                        <strong>Retrieved On:</strong><br>
                                        <i class="fas fa-clock text-secondary me-2"></i>
                                        {{ case.created_at | formatdate('%Y-%m-%d %H:%M:%S') }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sidebar -->
                    <div class="col-md-4">
                        <!-- PDF Documents -->
                        {% set pdf_links = case.pdf_links | fromjson if case.pdf_links else [] %}
                        <div class="card mb-4">
                            <div class="card-header bg-danger text-white">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-file-pdf me-2"></i>
                                    Documents ({{ pdf_links|length }})
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if pdf_links %}
                                    {% for link in pdf_links %}
                                    <div class="d-grid gap-2 mb-2">
                                        <a href="{{ url_for('download_pdf', case_id=case.id, link_index=loop.index0) }}" 
                                           class="btn btn-outline-danger btn-sm" target="_blank">
                                            <i class="fas fa-download me-2"></i>
                                            {{ link.text or 'Download PDF ' + loop.index|string }}
                                        </a>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center text-muted">
                                        <i class="fas fa-file-alt fa-3x mb-3 opacity-50"></i>
                                        <p class="mb-0">No PDF documents available</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-bolt me-2"></i>Quick Actions
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="shareCase()">
                                        <i class="fas fa-share me-2"></i>Share Case
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="exportCase()">
                                        <i class="fas fa-file-export me-2"></i>Export Details
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="printCase()">
                                        <i class="fas fa-print me-2"></i>Print Case
                                    </button>
                                    <a href="{{ url_for('search_case') }}" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-search me-2"></i>New Search
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Case Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shareUrl" class="form-label">Case URL:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="shareUrl" readonly 
                               value="{{ request.url }}">
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('shareUrl')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="caseInfo" class="form-label">Case Information:</label>
                    <textarea class="form-control" id="caseInfo" rows="4" readonly>Case: {{ case.case_type|title }} {{ case.case_number }}/{{ case.case_year }}
{% if case.parties %}Parties: {{ case.parties }}{% endif %}
{% if case.listing_date %}Listing Date: {{ case.listing_date }}{% endif %}
URL: {{ request.url }}</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyToClipboard('caseInfo')">
                    <i class="fas fa-copy me-2"></i>Copy All
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function shareCase() {
    const modal = new bootstrap.Modal(document.getElementById('shareModal'));
    modal.show();
}

function exportCase() {
    const caseData = {{ case.to_dict() | tojson | safe }};
    
    // Create downloadable JSON
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(caseData, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", `case_${caseData.case_number}_${caseData.case_year}.json`);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

function printCase() {
    window.print();
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    // Show toast notification
    const toast = document.createElement('div');
    toast.className = 'toast position-fixed top-0 end-0 m-3';
    toast.innerHTML = `
        <div class="toast-body bg-success text-white">
            <i class="fas fa-check me-2"></i>Copied to clipboard!
        </div>
    `;
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => {
        document.body.removeChild(toast);
    }, 3000);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        printCase();
    }
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        shareCase();
    }
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        exportCase();
    }
});
</script>

<style>
@media print {
    .btn, .card-header, .modal, .no-print {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .card-body {
        padding: 0 !important;
    }
}
</style>
{% endblock %}
